# Hybrid Imaging Search

This project provides a hybrid search solution for medical imaging data, combining deterministic metadata filtering with vector-based semantic search across DICOM metadata, text reports, and image content.

## Business Value

This application bridges the gap between complex medical imaging data and natural human language, democratizing access to DICOM studies. Working seamlessly with the [dcm2bq project](https://github.com/GoogleCloudPlatform/dcm2bq), it enables:

* **Natural Language Discovery of Complex Data:** Users can search massive DICOM datasets using plain English without needing to understand DICOM tags, SQL, or medical imaging expertise. Queries like "female patients 30-50 with emphysema" are instantly translated to sophisticated metadata and semantic searches.
* **Abstraction of Domain Complexity:** Domain expertise is no longer a prerequisite for data discovery. Clinicians, researchers, and analysts can explore imaging data naturally, discovering insights that previously required IT specialists or data engineers to extract.
* **Agentic Workflow Integration:** The MCP (Model Context Protocol) interface enables seamless integration with AI agents and autonomous workflows, allowing intelligent systems to discover and analyze imaging cohorts without human intervention.
* **Accelerated Research & Clinical Decision-Making:** Researchers and clinicians can rapidly identify relevant studies and patient cohorts based on complex criteria, reducing time from question to insight and supporting evidence-based decision-making.
* **Enterprise Scalability:** Powered by BigQuery and Vertex AI, the system scales effortlessly from small research projects to enterprise-wide imaging platforms.

## Example Queries Beyond Traditional DICOM Search

Traditional DICOM search typically relies on exact matches of specific metadata tags.  This system allows for more flexible and powerful queries, such as:

* "Find imaging studies for female patients between 30 and 50 years of age with Emphysema" (combines demographic filtering with a semantic search for a clinical finding).
* "Modality: ['CR', 'DX'], male patients, past 10 years, with pneumothorax findings" (combines metadata filtering and semantic search for a finding).

## Technical Value

The system offers several key technical advantages:

* **Natural Language â†’ SQL Translation:** Powered by Gemini, the system intelligently interprets natural language queries and translates them into optimized BigQuery SQL, abstracting away the complexity of database queries and DICOM schema knowledge.
* **Hybrid Search Strategy:** Combines deterministic filtering on DICOM metadata tags with vector-based semantic search on clinical reports and image embeddings (via dcm2bq). This allows both precise matching of known attributes and flexible retrieval based on clinical concepts and findings.
* **Full DICOM Metadata Access:** Works with the complete DICOM metadata hierarchy created by dcm2bq, enabling searches based on any DICOM tag without schema modification or manual annotation.
* **Vector Search for Clinical Findings:** Leverages embeddings generated by dcm2bq to find studies semantically similar to clinical search terms, enabling discovery beyond exact keyword matching.
* **MCP Integration for Autonomous Systems:** Exposes the query tool via the Model Context Protocol, enabling seamless integration with AI agents, automated workflows, and third-party applications without custom integration code.
* **Scalable Architecture:** Built on Google Cloud Platform (BigQuery, Vertex AI), designed for scalability and capable of handling large-scale medical imaging repositories.

## Getting Started

To run this project, you will need:

* A Google Cloud Platform account with BigQuery and Vertex AI enabled.
* Node.js and npm installed.
* **DICOM Data in BigQuery**: DICOM studies must be ingested into BigQuery using the [dcm2bq project](https://github.com/GoogleCloudPlatform/dcm2bq). This tool creates the required metadata tables and embeddings that the API queries.
* Environment: create `web/.env` with `GCP_PROJECT_ID=<your-project-id>` (required) and optional `PORT=5000`.

## Architecture

The project is split into two parts:

- **web/**: Combined Express API and React frontend. `/api/query` calls Gemini for SQL generation and BigQuery for results. Requires DICOM data ingested via [dcm2bq](https://github.com/GoogleCloudPlatform/dcm2bq). Starts both servers via `npm run dev` using `concurrently`.
- **mcp/**: Model Context Protocol (MCP) server exposing the `queryDicomData` tool via stdio, allowing integration with AI systems and tools. Proxies requests to the web API. Tested with Gemini CLI and VS Code MCP client.

## Running the full stack

1. Start the web app (API + React):
```bash
cd web
npm install
GCP_PROJECT_ID=<your-project-id> npm run dev
```
	- Development: serves React at http://localhost:3000 with proxy to the API on http://localhost:5000.
	- Production: `npm start` (builds React then runs `node server.js`).

2. In another terminal, start the MCP server:
```bash
cd mcp
npm install
npm start
```

The MCP server reaches the API at `http://localhost:5000/api/query` by default; override with `IMAGINGSEARCH_API_URL`.

## MCP Tool Reference

- **Tool name:** `queryDicomData`
- **Description:** Query DICOM imaging studies using natural language filters (modality, findings, demographics, date ranges). Forwards queries to the imaging search backend API, which uses Gemini to interpret natural language and generate optimized SQL.
- **Input:** `{ "textInput": "<natural language query>" }`
- **Output:** JSON containing:
  - `rows`: BigQuery results with patient and study metadata
  - `geminiResponse`: Generated SQL, WHERE clause, text search terms, image search terms, and notes
- **Example Query:** `"female patients 30-50 with emphysema"` returns studies matching demographic filters and the clinical finding.

See [mcp/README.md](mcp/README.md) for detailed testing instructions, client configuration examples (Gemini CLI, VS Code), and environment variable reference.